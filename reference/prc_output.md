# Patient Record Consistency – Output Generation

Using the tabular output generated by `prc_process`, this function will
build a graph to visualize the results. Each function configuration will
output a bespoke ggplot. Theming can be adjusted by the user after the
graph has been output using `+ theme()`. Most graphs can also be made
interactive using `make_interactive_squba()`

## Usage

``` r
prc_output(
  process_output,
  dist_from_stat = "mean",
  event_filter = NULL,
  large_n = FALSE,
  large_n_sites = NULL
)
```

## Arguments

- process_output:

  *tabular input* \|\| **required**

  The tabular output produced by `pes_process`

  Note any patient-level results generated are not intended to be used
  with this function.

- dist_from_stat:

  *string* \|\| defaults to `mean`

  A string indicating the statistic from which distance should be
  measured for the `Multi-Site, Exploratory, Longitudinal` check

  Acceptable values are `mean` or `median`

- event_filter:

  *string* \|\| defaults to `NULL`

  A string indicating the event co-occurrence type of interest for the
  analysis. This parameter is required for the following checks:

  - `Single Site, Anomaly Detection, Longitudinal`

  - `Multi-Site, Anomaly Detection, Longitudinal`

  Acceptable values are `a`, `b`, `both`, or `neither`

- large_n:

  *boolean* \|\| defaults to `FALSE`

  For Multi-Site analyses, a boolean indicating whether the large N
  visualization, intended for a high volume of sites, should be used.
  This visualization will produce high level summaries across all sites,
  with an option to add specific site comparators via the
  `large_n_sites` parameter.

- large_n_sites:

  *vector* \|\| defaults to `NULL`

  When `large_n = TRUE`, a vector of site names that can add site-level
  information to the plot for comparison across the high level summary
  information

## Value

This function will produce a graph to visualize the results from
`prc_process` based on the parameters provided. The default output is
typically a static ggplot or gt object, but interactive elements can be
activated by passing the plot through `make_interactive_squba`. For a
more detailed description of output specific to each check type, see the
PEDSpace metadata repository

## Examples

``` r
#' Source setup file
source(system.file('setup.R', package = 'patientrecordconsistency'))

#' Create in-memory RSQLite database using data in extdata directory
conn <- mk_testdb_omop()

#' Establish connection to database and generate internal configurations
initialize_dq_session(session_name = 'prc_process_test',
                      working_directory = my_directory,
                      db_conn = conn,
                      is_json = FALSE,
                      file_subdirectory = my_file_folder,
                      cdm_schema = NA)
#> Connected to: :memory:@NA

#' Build mock study cohort
cohort <- cdm_tbl('person') %>% dplyr::distinct(person_id) %>%
  dplyr::mutate(start_date = as.Date(-5000), # RSQLite does not store date objects,
                                      # hence the numerics
                end_date = as.Date(15000),
                site = ifelse(person_id %in% c(1:6), 'synth1', 'synth2'))

#' Build function input table
prc_events <- tidyr::tibble(event = c('a', 'b'),
                            event_label = c('hypertension', 'inpatient/ED visit'),
                            domain_tbl = c('condition_occurrence', 'visit_occurrence'),
                            concept_field = c('condition_concept_id', 'visit_concept_id'),
                            date_field = c('condition_start_date', 'visit_start_date'),
                            vocabulary_field = c(NA, NA),
                            codeset_name = c('dx_hypertension', 'visit_edip'),
                            filter_logic = c(NA, NA))

#' Execute `prc_process` function
#' This example will use the single site, exploratory, cross sectional
#' configuration
prc_process_example <- prc_process(cohort = cohort,
                                   multi_or_single_site = 'single',
                                   anomaly_or_exploratory = 'exploratory',
                                   time = FALSE,
                                   omop_or_pcornet = 'omop',
                                   prc_event_file = prc_events) %>%
  suppressMessages()
#> ┌ Output Function Details ──────────────────────────────────────┐
#> │ You can optionally use this dataframe in the accompanying     │
#> │ `prc_output` function. Here are the parameters you will need: │
#> │                                                               │
#> │ Always Required: process_output                               │
#> │                                                               │
#> │ See ?prc_output for more details.                             │
#> └───────────────────────────────────────────────────────────────┘

prc_process_example
#> # A tibble: 5 × 8
#>   site     event_a_num event_a_name event_b_num event_b_name     pt_ct total_pts
#>   <chr>          <dbl> <chr>              <dbl> <chr>            <int>     <int>
#> 1 combined           0 hypertension           0 inpatient/ED vi…     6        12
#> 2 combined           0 hypertension           1 inpatient/ED vi…     1        12
#> 3 combined           1 hypertension           1 inpatient/ED vi…     2        12
#> 4 combined           1 hypertension           2 inpatient/ED vi…     2        12
#> 5 combined           1 hypertension           5 inpatient/ED vi…     1        12
#> # ℹ 1 more variable: output_function <chr>

#' Execute `prc_output` function
prc_output_example <- prc_output(process_output = prc_process_example)

prc_output_example


#' Easily convert the graph into an interactive ggiraph or plotly object with
#' `make_interactive_squba()`

make_interactive_squba(prc_output_example)

{"x":{"html":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' class='ggiraph-svg' role='graphics-document' id='svg_c00206b0c5da0b26' viewBox='0 0 432 360'>\n <defs id='svg_c00206b0c5da0b26_defs'>\n  <clipPath id='svg_c00206b0c5da0b26_c1'>\n   <rect x='0' y='0' width='432' height='360'/>\n  <\/clipPath>\n  <clipPath id='svg_c00206b0c5da0b26_c2'>\n   <rect x='37.44' y='23.32' width='365.5' height='304.97'/>\n  <\/clipPath>\n <\/defs>\n <g id='svg_c00206b0c5da0b26_rootg' class='ggiraph-svg-rootg'>\n  <g clip-path='url(#svg_c00206b0c5da0b26_c1)'>\n   <rect x='0' y='0' width='432' height='360' fill='#FFFFFF' fill-opacity='1' stroke='#FFFFFF' stroke-opacity='1' stroke-width='0.75' stroke-linejoin='round' stroke-linecap='round' class='ggiraph-svg-bg'/>\n   <rect x='0' y='0' width='432' height='360' fill='#FFFFFF' fill-opacity='1' stroke='none'/>\n  <\/g>\n  <g clip-path='url(#svg_c00206b0c5da0b26_c2)'>\n   <polyline points='37.44,286.71 402.94,286.71' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='0.53' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,231.26 402.94,231.26' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='0.53' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,175.81 402.94,175.81' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='0.53' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,120.36 402.94,120.36' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='0.53' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,64.91 402.94,64.91' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='0.53' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,314.43 402.94,314.43' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,258.98 402.94,258.98' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,203.53 402.94,203.53' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,148.08 402.94,148.08' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,92.63 402.94,92.63' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='37.44,37.18 402.94,37.18' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='105.97,328.29 105.97,23.32' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='220.19,328.29 220.19,23.32' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='334.41,328.29 334.41,23.32' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <rect id='svg_c00206b0c5da0b26_e1' x='54.58' y='83.39' width='102.8' height='231.04' fill='#FF4D6F' fill-opacity='1' stroke='none' title='Event Name: Both&amp;lt;br/&amp;gt;Proportion: 0.417&amp;lt;br/&amp;gt;Patient Count: 5&amp;lt;br/&amp;gt;Avg No. Event A: 0.417&amp;lt;br/&amp;gt;Avg No. Event B: 1'/>\n   <rect id='svg_c00206b0c5da0b26_e2' x='168.8' y='268.22' width='102.8' height='46.21' fill='#5D7298' fill-opacity='1' stroke='none' title='Event Name: inpatient/ED visit&amp;lt;br/&amp;gt;Proportion: 0.083&amp;lt;br/&amp;gt;Patient Count: 1&amp;lt;br/&amp;gt;Avg No. Event A: 0.417&amp;lt;br/&amp;gt;Avg No. Event B: 1'/>\n   <rect id='svg_c00206b0c5da0b26_e3' x='283.01' y='37.18' width='102.8' height='277.25' fill='#BD777A' fill-opacity='1' stroke='none' title='Event Name: Neither&amp;lt;br/&amp;gt;Proportion: 0.5&amp;lt;br/&amp;gt;Patient Count: 6&amp;lt;br/&amp;gt;Avg No. Event A: 0.417&amp;lt;br/&amp;gt;Avg No. Event B: 1'/>\n  <\/g>\n  <g clip-path='url(#svg_c00206b0c5da0b26_c1)'>\n   <text x='18.53' y='317.64' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>0.0<\/text>\n   <text x='18.53' y='262.19' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>0.1<\/text>\n   <text x='18.53' y='206.74' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>0.2<\/text>\n   <text x='18.53' y='151.29' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>0.3<\/text>\n   <text x='18.53' y='95.84' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>0.4<\/text>\n   <text x='18.53' y='40.39' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>0.5<\/text>\n   <text x='407.88' y='317.64' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>0<\/text>\n   <text x='407.88' y='225.22' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>2<\/text>\n   <text x='407.88' y='132.81' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>4<\/text>\n   <text x='407.88' y='40.39' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>6<\/text>\n   <text x='79.46' y='339.64' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>Both Events<\/text>\n   <text x='191.71' y='339.64' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>Event B Only<\/text>\n   <text x='304.17' y='339.64' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>Neither Event<\/text>\n   <text transform='translate(13.50,227.95) rotate(-90.00)' font-size='8.25pt' font-family='DejaVu Sans'>Proportion Patients<\/text>\n   <text transform='translate(418.50,138.58) rotate(90.00)' font-size='8.25pt' font-family='DejaVu Sans'>Patient Count<\/text>\n   <text x='37.44' y='15.1' font-size='9.9pt' font-family='DejaVu Sans'>Proportion Patients with Each Event<\/text>\n  <\/g>\n <\/g>\n<\/svg>","js":null,"uid":"svg_c00206b0c5da0b26","ratio":1.2,"settings":{"tooltip":{"css":".tooltip_SVGID_ { padding:5px;background:black;color:white;border-radius:2px;text-align:left; ; position:absolute;pointer-events:none;z-index:999;}","placement":"doc","opacity":0.9,"offx":10,"offy":10,"use_cursor_pos":true,"use_fill":false,"use_stroke":false,"delay_over":200,"delay_out":500},"hover":{"css":".hover_data_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_data_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_data_SVGID_ { fill:orange;stroke:black; }\nline.hover_data_SVGID_, polyline.hover_data_SVGID_ { fill:none;stroke:orange; }\nrect.hover_data_SVGID_, polygon.hover_data_SVGID_, path.hover_data_SVGID_ { fill:orange;stroke:none; }\nimage.hover_data_SVGID_ { stroke:orange; }","reactive":true,"nearest_distance":null},"hover_inv":{"css":""},"hover_key":{"css":".hover_key_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_key_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_key_SVGID_ { fill:orange;stroke:black; }\nline.hover_key_SVGID_, polyline.hover_key_SVGID_ { fill:none;stroke:orange; }\nrect.hover_key_SVGID_, polygon.hover_key_SVGID_, path.hover_key_SVGID_ { fill:orange;stroke:none; }\nimage.hover_key_SVGID_ { stroke:orange; }","reactive":true},"hover_theme":{"css":".hover_theme_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_theme_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_theme_SVGID_ { fill:orange;stroke:black; }\nline.hover_theme_SVGID_, polyline.hover_theme_SVGID_ { fill:none;stroke:orange; }\nrect.hover_theme_SVGID_, polygon.hover_theme_SVGID_, path.hover_theme_SVGID_ { fill:orange;stroke:none; }\nimage.hover_theme_SVGID_ { stroke:orange; }","reactive":true},"select":{"css":".select_data_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_data_SVGID_ { stroke:none;fill:red; }\ncircle.select_data_SVGID_ { fill:red;stroke:black; }\nline.select_data_SVGID_, polyline.select_data_SVGID_ { fill:none;stroke:red; }\nrect.select_data_SVGID_, polygon.select_data_SVGID_, path.select_data_SVGID_ { fill:red;stroke:none; }\nimage.select_data_SVGID_ { stroke:red; }","type":"multiple","only_shiny":true,"selected":[]},"select_inv":{"css":""},"select_key":{"css":".select_key_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_key_SVGID_ { stroke:none;fill:red; }\ncircle.select_key_SVGID_ { fill:red;stroke:black; }\nline.select_key_SVGID_, polyline.select_key_SVGID_ { fill:none;stroke:red; }\nrect.select_key_SVGID_, polygon.select_key_SVGID_, path.select_key_SVGID_ { fill:red;stroke:none; }\nimage.select_key_SVGID_ { stroke:red; }","type":"single","only_shiny":true,"selected":[]},"select_theme":{"css":".select_theme_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_theme_SVGID_ { stroke:none;fill:red; }\ncircle.select_theme_SVGID_ { fill:red;stroke:black; }\nline.select_theme_SVGID_, polyline.select_theme_SVGID_ { fill:none;stroke:red; }\nrect.select_theme_SVGID_, polygon.select_theme_SVGID_, path.select_theme_SVGID_ { fill:red;stroke:none; }\nimage.select_theme_SVGID_ { stroke:red; }","type":"single","only_shiny":true,"selected":[]},"zoom":{"min":1,"max":1,"duration":300,"default_on":false},"toolbar":{"position":"topright","pngname":"diagram","tooltips":null,"fixed":false,"hidden":[],"delay_over":200,"delay_out":500},"sizing":{"rescale":true,"width":1}}},"evals":[],"jsHooks":[]}
```
